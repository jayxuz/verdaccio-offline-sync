# Verdaccio Offline Sync

[English](./README.en.md) | ä¸­æ–‡

[![npm version - ingest-middleware](https://img.shields.io/npm/v/verdaccio-ingest-middleware.svg?label=ingest-middleware)](https://www.npmjs.com/package/verdaccio-ingest-middleware)
[![npm version - metadata-healer](https://img.shields.io/npm/v/verdaccio-metadata-healer.svg?label=metadata-healer)](https://www.npmjs.com/package/verdaccio-metadata-healer)
[![npm version - offline-storage](https://img.shields.io/npm/v/@jayxuz/verdaccio-offline-storage.svg?label=offline-storage)](https://www.npmjs.com/package/@jayxuz/verdaccio-offline-storage)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**Verdaccio ç¦»çº¿ NPM ä¾èµ–ç®¡ç†æ’ä»¶å¥—ä»¶** - ä¸“ä¸ºå†…å¤–ç½‘éš”ç¦»ç¯å¢ƒè®¾è®¡çš„ npm åŒ…åŒæ­¥è§£å†³æ–¹æ¡ˆã€‚

## æ ¸å¿ƒç‰¹æ€§

- **é€’å½’ä¾èµ–ä¸‹è½½** - è‡ªåŠ¨åˆ†æå¹¶ä¸‹è½½å®Œæ•´çš„ä¾èµ–æ ‘
- **å¤šå¹³å°äºŒè¿›åˆ¶æ”¯æŒ** - æ”¯æŒ Linux/Windows/macOS çš„ x64/arm64 æ¶æ„
- **å¢é‡åŒæ­¥** - åŸºäºå·²ç¼“å­˜åŒ…çš„æ™ºèƒ½å¢é‡æ›´æ–°
- **å·®åˆ†å¯¼å‡º/å¯¼å…¥** - æ”¯æŒåŸºäºæ—¶é—´ç‚¹çš„å·®åˆ†åŒ…å¯¼å‡ºå’Œå†…ç½‘å¯¼å…¥
- **å¯è§†åŒ–ç®¡ç†ç•Œé¢** - å†…ç½® Web UIï¼Œæ”¯æŒåˆ†æ-ç¡®è®¤-ä¸‹è½½å·¥ä½œæµ
- **å®æ—¶è¿›åº¦è¿½è¸ª** - æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ã€é¢„ä¼°å‰©ä½™æ—¶é—´
- **å…ƒæ•°æ®è‡ªæ„ˆ** - å†…ç½‘è‡ªåŠ¨ä¿®å¤ç¼ºå¤±çš„åŒ…å…ƒæ•°æ®

## æ’ä»¶ç»„æˆ

| æ’ä»¶ | éƒ¨ç½²ä½ç½® | åŠŸèƒ½ |
|------|----------|------|
| `@jayxuz/verdaccio-offline-storage` | å¤–ç½‘/å†…ç½‘ | åŸºç¡€å­˜å‚¨å±‚ï¼Œæ”¯æŒç¦»çº¿ç‰ˆæœ¬è§£æ |
| `verdaccio-ingest-middleware` | å¤–ç½‘ | é€’å½’æ‘„å–ä¸­é—´ä»¶ï¼Œæä¾› Web UIï¼Œæ”¯æŒå·®åˆ†å¯¼å‡º |
| `verdaccio-metadata-healer` | å†…ç½‘ | å…ƒæ•°æ®è‡ªæ„ˆè¿‡æ»¤å™¨ï¼Œæ”¯æŒå·®åˆ†å¯¼å…¥ |

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–ç½‘ç¯å¢ƒ                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Verdaccio + offline-storage + ingest-middleware            â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Web UI: http://external:4873/_/ingest/ui                   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ç¼“å­˜çŠ¶æ€æŸ¥çœ‹                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ åˆ†æä¾èµ– â†’ ç¡®è®¤ä¸‹è½½åˆ—è¡¨ â†’ æ‰§è¡Œä¸‹è½½                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å®æ—¶è¿›åº¦è¿½è¸ªï¼ˆç™¾åˆ†æ¯”ã€é¢„ä¼°æ—¶é—´ã€å½“å‰åŒ…ï¼‰                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ğŸ“¤ å·®åˆ†å¯¼å‡ºï¼ˆåŸºäºæ—¶é—´ç‚¹å¯¼å‡ºå¢é‡åŒ…ï¼‰                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚                    storage/ ç›®å½•                                    â”‚
â”‚                    â”œâ”€â”€ react/                                       â”‚
â”‚                    â”‚   â”œâ”€â”€ package.json                             â”‚
â”‚                    â”‚   â””â”€â”€ react-18.2.0.tgz                         â”‚
â”‚                    â”œâ”€â”€ @esbuild%2flinux-x64/                        â”‚
â”‚                    â”‚   â””â”€â”€ linux-x64-0.19.0.tgz                     â”‚
â”‚                    â”œâ”€â”€ .export-history.json  â† å¯¼å‡ºå†å²è®°å½•          â”‚
â”‚                    â””â”€â”€ .exports/             â† å¯¼å‡ºåŒ…å­˜æ”¾ç›®å½•        â”‚
â”‚                        â””â”€â”€ diff-export-2024-01-15T10-30-00.tar.gz   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ æ–¹å¼1: rsync -avz --ignore-existing
                               â”‚ æ–¹å¼2: ä¸‹è½½å·®åˆ†åŒ… â†’ å†…ç½‘å¯¼å…¥
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å†…ç½‘ç¯å¢ƒ                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Verdaccio + offline-storage + metadata-healer              â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  å¯¼å…¥ UI: http://internal:4873/_/healer/ui                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ğŸ“¥ ä¸Šä¼ å·®åˆ†åŒ…                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¯¼å…¥é€‰é¡¹ï¼ˆè¦†ç›–/æ ¡éªŒ/é‡å»ºå…ƒæ•°æ®ï¼‰                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å¯¼å…¥å†å²è®°å½•                                            â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  npm install react --registry http://internal:4873          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ offline-storage æœ¬åœ°è§£æç‰ˆæœ¬                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ metadata-healer åŠ¨æ€ä¿®å¤ç¼ºå¤±å…ƒæ•°æ®                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ è‡ªåŠ¨é€‰æ‹©å½“å‰å¹³å°çš„äºŒè¿›åˆ¶åŒ…                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…å‰ç½®ä¾èµ–

```bash
# å®‰è£…ç¦»çº¿å­˜å‚¨æ’ä»¶ï¼ˆå¿…éœ€ï¼‰
npm install -g @jayxuz/verdaccio-offline-storage
```

### 2. å®‰è£…æ’ä»¶

```bash
# å¤–ç½‘ç¯å¢ƒ
npm install -g verdaccio-ingest-middleware

# å†…ç½‘ç¯å¢ƒ
npm install -g verdaccio-metadata-healer
```

### 3. é…ç½®å¤–ç½‘ Verdaccio

```yaml
# config-external.yaml
storage: /verdaccio/storage/data

store:
  offline-storage:
    offline: false

uplinks:
  npmjs:
    url: https://registry.npmmirror.com

packages:
  '@*/*':
    access: $all
    publish: $authenticated
    proxy: npmjs
  '**':
    access: $all
    publish: $authenticated
    proxy: npmjs

middlewares:
  ingest-middleware:
    enabled: true
    upstreamRegistry: https://registry.npmmirror.com
    concurrency: 5
    timeout: 60000
    platforms:
      - os: linux
        arch: x64
        libc: glibc
      - os: linux
        arch: arm64
        libc: glibc
      - os: win32
        arch: x64
      - os: win32
        arch: arm64
    sync:
      updateToLatest: true
      includeDev: false
      includePeer: true
      includeOptional: true
      maxDepth: 10
```

### 4. é…ç½®å†…ç½‘ Verdaccio

```yaml
# config-internal.yaml
storage: /verdaccio/storage/data

store:
  offline-storage:
    offline: true  # å¼ºåˆ¶ç¦»çº¿æ¨¡å¼

packages:
  '@*/*':
    access: $all
    publish: $authenticated
  '**':
    access: $all
    publish: $authenticated

filters:
  metadata-healer:
    enabled: true
    scanCacheTTL: 60000
    shasumCacheSize: 10000
    autoUpdateLatest: true

# å¯ç”¨å¯¼å…¥ä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼Œç”¨äº Web UI å¯¼å…¥å·®åˆ†åŒ…ï¼‰
middlewares:
  import-middleware:
    enabled: true
```

## Web UI ä½¿ç”¨æŒ‡å—

è®¿é—® `http://external:4873/_/ingest/ui` æ‰“å¼€ç®¡ç†ç•Œé¢ã€‚

### åŠŸèƒ½æ¨¡å—

#### 1. ç¼“å­˜çŠ¶æ€

æ˜¾ç¤ºå½“å‰æœ¬åœ°ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯ï¼š
- æ€»åŒ…æ•°
- æ€»ç‰ˆæœ¬æ•°
- ä¸Šæ¬¡åŒæ­¥æ—¶é—´

#### 2. å¿«é€Ÿæ“ä½œ

| æŒ‰é’® | åŠŸèƒ½ |
|------|------|
| åˆ·æ–°æ‰€æœ‰å…ƒæ•°æ® | ä»ä¸Šæ¸¸ä»“åº“æ›´æ–°æ‰€æœ‰å·²ç¼“å­˜åŒ…çš„å…ƒæ•°æ® |
| åŒæ­¥ç¼ºå¤±ä¾èµ– | è·³è½¬åˆ°åŒæ­¥é…ç½®åŒºåŸŸ |
| é‡å»ºæœ¬åœ°ç´¢å¼• | æ‰«æå­˜å‚¨ç›®å½•ï¼Œä¿®å¤å…ƒæ•°æ®ï¼ˆå†…ç½‘ä½¿ç”¨ï¼‰ |

#### 3. åŒæ­¥é…ç½®

**ç›®æ ‡å¹³å°é€‰æ‹©ï¼š**
- Linux x64 / ARM64
- Windows x64 / ARM64
- macOS x64 / ARM64

**åŒæ­¥é€‰é¡¹ï¼š**
| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ | æ£€æŸ¥å·²ç¼“å­˜åŒ…æ˜¯å¦æœ‰æ›´æ–°ç‰ˆæœ¬ |
| åŒ…å«å¯é€‰ä¾èµ– | ä¸‹è½½ optionalDependenciesï¼ˆå¹³å°äºŒè¿›åˆ¶åŒ…ï¼‰ |
| åŒ…å«å¯¹ç­‰ä¾èµ– | ä¸‹è½½ peerDependencies |

#### 4. åˆ†æ-ç¡®è®¤-ä¸‹è½½å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†æä¾èµ–    â”‚ â”€â”€â–¶â”‚  ç¡®è®¤åˆ—è¡¨    â”‚ â”€â”€â–¶â”‚  æ‰§è¡Œä¸‹è½½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                   â”‚                   â”‚
      â–¼                   â–¼                   â–¼
 æ˜¾ç¤ºè¯¦ç»†è¿›åº¦        å±•ç¤ºå¾…ä¸‹è½½åŒ…        æ˜¾ç¤ºä¸‹è½½ç»“æœ
 - å½“å‰é˜¶æ®µ          - åŒ…å@ç‰ˆæœ¬         - æˆåŠŸ/å¤±è´¥æ•°
 - ç™¾åˆ†æ¯”            - ä¸‹è½½åŸå›           - å¤±è´¥åˆ—è¡¨
 - é¢„ä¼°å‰©ä½™æ—¶é—´      - æ”¯æŒå–æ¶ˆ          - æ”¯æŒé‡è¯•
 - å½“å‰å¤„ç†çš„åŒ…
```

**åˆ†æé˜¶æ®µè¿›åº¦ï¼š**
| é˜¶æ®µ | è¿›åº¦èŒƒå›´ | è¯´æ˜ |
|------|----------|------|
| æ‰«ææœ¬åœ°ç¼“å­˜ | 0-5% | æ‰«æ storage ç›®å½• |
| åˆ·æ–°å…ƒæ•°æ® | 5-30% | ä»ä¸Šæ¸¸è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ |
| åˆ†æä¾èµ–å…³ç³» | 30-80% | BFS éå†ä¾èµ–æ ‘ |
| æ£€æµ‹å¹³å°äºŒè¿›åˆ¶åŒ… | 80-95% | è¯†åˆ«éœ€è¦ä¸‹è½½çš„å¹³å°åŒ… |
| å®Œæˆ | 100% | ç”Ÿæˆä¸‹è½½åˆ—è¡¨ |

#### 5. æ‰§è¡Œæ—¥å¿—

- å®æ—¶æ˜¾ç¤ºæ“ä½œæ—¥å¿—
- æ”¯æŒæ—¥å¿—å¯¼å‡ºï¼ˆTXT æ ¼å¼ï¼‰
- æ”¯æŒæ¸…ç©ºæ—¥å¿—

#### 6. å·²ç¼“å­˜çš„åŒ…åˆ—è¡¨

æ˜¾ç¤ºæœ¬åœ°å·²ç¼“å­˜çš„åŒ…ï¼š
- åŒ…å
- ç‰ˆæœ¬æ•°é‡
- æœ€æ–°ç¼“å­˜ç‰ˆæœ¬

#### 7. å·®åˆ†å¯¼å‡ºï¼ˆå¤–ç½‘ï¼‰

åœ¨ Web UI åº•éƒ¨çš„ã€ŒğŸ“¤ å·®åˆ†å¯¼å‡ºã€å¡ç‰‡ä¸­ï¼š

**å¯¼å‡ºå†å²ï¼š** æ˜¾ç¤ºæœ€è¿‘çš„å¯¼å‡ºè®°å½•

**åŸºå‡†æ—¶é—´é€‰æ‹©ï¼š**
| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| ä¸Šæ¬¡å¯¼å‡ºæ—¶é—´ | ä»ä¸Šæ¬¡å¯¼å‡ºæ—¶é—´ç‚¹å¼€å§‹ï¼Œåªå¯¼å‡ºæ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶ |
| è‡ªå®šä¹‰æ—¶é—´ | æ‰‹åŠ¨æŒ‡å®šåŸºå‡†æ—¶é—´ç‚¹ |
| å…¨é‡å¯¼å‡º | å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œä¸è€ƒè™‘æ—¶é—´ç‚¹ |

**å¯¼å‡ºé€‰é¡¹ï¼š**
- åŒ…å«å…ƒæ•°æ®æ–‡ä»¶ï¼šæ˜¯å¦åŒ…å« package.json æ–‡ä»¶

**å·¥ä½œæµç¨‹ï¼š**
```
é¢„è§ˆå˜æ›´ â†’ æŸ¥çœ‹å¾…å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨ â†’ åˆ›å»ºå¯¼å‡ºåŒ… â†’ ä¸‹è½½ tar.gz
```

**å¯¼å‡ºåŒ…ç»“æ„ï¼š**
```
diff-export-2024-01-15T10-30-00.tar.gz
â”œâ”€â”€ .export-manifest.json      # å¯¼å‡ºæ¸…å•ï¼ˆåŒ…å«æ–‡ä»¶åˆ—è¡¨å’Œæ ¡éªŒå’Œï¼‰
â”œâ”€â”€ react/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ react-18.2.0.tgz
â”œâ”€â”€ @esbuild%2flinux-x64/
â”‚   â””â”€â”€ linux-x64-0.19.0.tgz
â””â”€â”€ lodash/
    â””â”€â”€ lodash-4.17.21.tgz
```

#### 8. å·®åˆ†å¯¼å…¥ï¼ˆå†…ç½‘ï¼‰

è®¿é—® `http://internal:4873/_/healer/ui` æ‰“å¼€å¯¼å…¥ç®¡ç†ç•Œé¢ã€‚

**ä¸Šä¼ å·®åˆ†åŒ…ï¼š**
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
- åªæ¥å— .tar.gz æˆ– .tgz æ ¼å¼

**å¯¼å…¥é€‰é¡¹ï¼š**
| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ | å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼ˆé»˜è®¤è·³è¿‡ï¼‰ |
| éªŒè¯æ–‡ä»¶æ ¡éªŒå’Œ | å¯¼å…¥å‰éªŒè¯ SHA256 æ ¡éªŒå’Œï¼Œç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§ |
| è‡ªåŠ¨é‡å»ºå…ƒæ•°æ® | å¯¼å…¥åè§¦å‘å…ƒæ•°æ®é‡å»ºï¼Œä½¿æ–°åŒ…ç«‹å³å¯ç”¨ |

**å¯¼å…¥è¿›åº¦é˜¶æ®µï¼š**
| é˜¶æ®µ | è¯´æ˜ |
|------|------|
| è§£å‹æ–‡ä»¶ | è§£å‹ tar.gz åˆ°ä¸´æ—¶ç›®å½• |
| éªŒè¯æ ¡éªŒå’Œ | éªŒè¯æ¯ä¸ªæ–‡ä»¶çš„ SHA256 |
| å¯¼å…¥æ–‡ä»¶ | å¤åˆ¶æ–‡ä»¶åˆ° storage ç›®å½• |
| é‡å»ºå…ƒæ•°æ® | è§¦å‘å…ƒæ•°æ®è‡ªåŠ¨é‡å»º |

## API ç«¯ç‚¹

### å¤–ç½‘æ’ä»¶ (ingest-middleware)

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/_/ingest/ui` | GET | Web ç®¡ç†ç•Œé¢ |
| `/_/ingest/cache` | GET | æŸ¥çœ‹æœ¬åœ°ç¼“å­˜çŠ¶æ€ |
| `/_/ingest/refresh` | POST | åˆ·æ–°å·²ç¼“å­˜åŒ…çš„å…ƒæ•°æ® |
| `/_/ingest/analyze` | POST | åˆ†æä¾èµ–ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ |
| `/_/ingest/analysis/:id` | GET | è·å–åˆ†æç»“æœ |
| `/_/ingest/download` | POST | æ‰§è¡Œä¸‹è½½ï¼ˆåŸºäºåˆ†æç»“æœï¼‰ |
| `/_/ingest/retry` | POST | é‡è¯•å¤±è´¥çš„ä¸‹è½½ |
| `/_/ingest/sync` | POST | ä¸€é”®åŒæ­¥ï¼ˆåˆ†æ+ä¸‹è½½ï¼‰ |
| `/_/ingest/platform` | POST | ä¸‹è½½æŒ‡å®šåŒ…çš„å¤šå¹³å°ç‰ˆæœ¬ |
| `/_/ingest/status/:taskId` | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ |
| `/_/ingest/rebuild-index` | POST | é‡å»ºæœ¬åœ°ç´¢å¼• |
| `/_/ingest/export/history` | GET | è·å–å¯¼å‡ºå†å² |
| `/_/ingest/export/preview` | POST | é¢„è§ˆå¾…å¯¼å‡ºæ–‡ä»¶ |
| `/_/ingest/export/create` | POST | åˆ›å»ºå·®åˆ†å¯¼å‡ºåŒ… |
| `/_/ingest/export/download/:exportId` | GET | ä¸‹è½½å¯¼å‡ºåŒ… |

### å†…ç½‘æ’ä»¶ (import-middleware)

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/_/healer/ui` | GET | å¯¼å…¥ç®¡ç†ç•Œé¢ |
| `/_/healer/import/upload` | POST | ä¸Šä¼ å¹¶å¯¼å…¥å·®åˆ†åŒ… |
| `/_/healer/import/status/:taskId` | GET | æŸ¥è¯¢å¯¼å…¥ä»»åŠ¡çŠ¶æ€ |
| `/_/healer/import/history` | GET | è·å–å¯¼å…¥å†å² |

### API ç¤ºä¾‹

#### åˆ†æä¾èµ–

```bash
curl -X POST http://external:4873/_/ingest/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "platforms": [
      {"os": "linux", "arch": "x64", "libc": "glibc"},
      {"os": "win32", "arch": "x64"}
    ],
    "options": {
      "updateToLatest": true,
      "includeOptional": true,
      "includePeer": true
    }
  }'

# å“åº”
{
  "success": true,
  "taskId": "task-1234567890-abc123",
  "message": "Analysis task started"
}
```

#### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```bash
curl http://external:4873/_/ingest/status/task-1234567890-abc123

# å“åº”ï¼ˆè¿›è¡Œä¸­ï¼‰
{
  "taskId": "task-1234567890-abc123",
  "status": "running",
  "progress": 45,
  "message": "åˆ†æä¾èµ– (å±‚çº§ 2): lodash",
  "detailedProgress": {
    "phase": "analyzing",
    "phaseProgress": 60,
    "totalProgress": 45,
    "currentPackage": "lodash@4.17.21",
    "processed": 120,
    "total": 200,
    "estimatedRemaining": 30000,
    "phaseDescription": "åˆ†æä¾èµ– (å±‚çº§ 2): lodash"
  }
}

# å“åº”ï¼ˆå®Œæˆï¼‰
{
  "taskId": "task-1234567890-abc123",
  "status": "completed",
  "progress": 100,
  "result": {
    "analysisId": "analysis-1234567890-xyz789",
    "scanned": 150,
    "refreshed": 150,
    "toDownload": [...],
    "platforms": ["linux-x64", "win32-x64"],
    "timestamp": 1234567890000
  }
}
```

#### æ‰§è¡Œä¸‹è½½

```bash
curl -X POST http://external:4873/_/ingest/download \
  -H "Content-Type: application/json" \
  -d '{
    "analysisId": "analysis-1234567890-xyz789"
  }'
```

## åŒæ­¥å·¥ä½œæµ

### æ–¹å¼ä¸€ï¼šrsync ç›´æ¥åŒæ­¥

```bash
# 1. å¤–ç½‘ï¼šæ‰“å¼€ Web UI è¿›è¡ŒåŒæ­¥
#    è®¿é—® http://external:4873/_/ingest/ui
#    é€‰æ‹©ç›®æ ‡å¹³å° â†’ åˆ†æä¾èµ– â†’ ç¡®è®¤ä¸‹è½½ â†’ æ‰§è¡Œä¸‹è½½

# 2. å·®åˆ†åŒæ­¥åˆ°å†…ç½‘
rsync -avz --ignore-existing /external/storage/ /internal/storage/

# 3. å†…ç½‘ï¼šé‡å»ºç´¢å¼•ï¼ˆé¦–æ¬¡æˆ–æœ‰é—®é¢˜æ—¶ï¼‰
curl -X POST http://internal:4873/_/ingest/rebuild-index

# 4. å†…ç½‘ï¼šæ­£å¸¸ä½¿ç”¨
npm install <package> --registry http://internal:4873
```

### æ–¹å¼äºŒï¼šå·®åˆ†åŒ…å¯¼å‡º/å¯¼å…¥ï¼ˆæ¨èï¼‰

é€‚ç”¨äºæ— æ³•ç›´æ¥ rsync çš„åœºæ™¯ï¼ˆå¦‚é€šè¿‡ U ç›˜ä¼ è¾“ï¼‰ã€‚

```bash
# 1. å¤–ç½‘ï¼šæ‰“å¼€ Web UI
#    è®¿é—® http://external:4873/_/ingest/ui

# 2. å¤–ç½‘ï¼šä¸‹è½½ä¾èµ–ï¼ˆåŒæ–¹å¼ä¸€ï¼‰
#    é€‰æ‹©ç›®æ ‡å¹³å° â†’ åˆ†æä¾èµ– â†’ ç¡®è®¤ä¸‹è½½ â†’ æ‰§è¡Œä¸‹è½½

# 3. å¤–ç½‘ï¼šåˆ›å»ºå·®åˆ†å¯¼å‡ºåŒ…
#    åœ¨ã€ŒğŸ“¤ å·®åˆ†å¯¼å‡ºã€å¡ç‰‡ä¸­ï¼š
#    é€‰æ‹©åŸºå‡†æ—¶é—´ï¼ˆä¸Šæ¬¡å¯¼å‡º/è‡ªå®šä¹‰/å…¨é‡ï¼‰â†’ é¢„è§ˆå˜æ›´ â†’ åˆ›å»ºå¯¼å‡ºåŒ… â†’ ä¸‹è½½

# 4. å°† diff-export-xxx.tar.gz ä¼ è¾“åˆ°å†…ç½‘

# 5. å†…ç½‘ï¼šæ‰“å¼€å¯¼å…¥ Web UI
#    è®¿é—® http://internal:4873/_/healer/ui

# 6. å†…ç½‘ï¼šä¸Šä¼ å¹¶å¯¼å…¥å·®åˆ†åŒ…
#    æ‹–æ‹½ä¸Šä¼  â†’ é€‰æ‹©å¯¼å…¥é€‰é¡¹ â†’ å¼€å§‹å¯¼å…¥

# 7. å†…ç½‘ï¼šæ­£å¸¸ä½¿ç”¨
npm install <package> --registry http://internal:4873
```

### å‘½ä»¤è¡Œæ–¹å¼

```bash
# å¤–ç½‘ï¼šä¸€é”®åŒæ­¥
curl -X POST http://external:4873/_/ingest/sync \
  -H "Content-Type: application/json" \
  -d '{
    "platforms": [
      {"os": "linux", "arch": "x64", "libc": "glibc"},
      {"os": "win32", "arch": "x64"}
    ],
    "options": {
      "updateToLatest": true,
      "includeOptional": true
    }
  }'
```

## å¤šå¹³å°äºŒè¿›åˆ¶åŒ…æ”¯æŒ

è‡ªåŠ¨æ£€æµ‹å¹¶ä¸‹è½½ä»¥ä¸‹ç±»å‹çš„å¹³å°ç‰¹å®šåŒ…ï¼š

| åŒ…åæ¨¡å¼ | ç¤ºä¾‹ |
|----------|------|
| `@esbuild/*` | @esbuild/linux-x64, @esbuild/win32-x64 |
| `@swc/core-*` | @swc/core-linux-x64-gnu, @swc/core-win32-x64-msvc |
| `@rollup/rollup-*` | @rollup/rollup-linux-x64-gnu |
| `@img/sharp-*` | @img/sharp-linux-x64, @img/sharp-win32-x64 |

## é…ç½®å‚è€ƒ

### ingest-middleware é…ç½®é¡¹

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enabled` | boolean | true | æ˜¯å¦å¯ç”¨æ’ä»¶ |
| `upstreamRegistry` | string | å–è‡ª uplinks é…ç½® | ä¸Šæ¸¸ä»“åº“åœ°å€ï¼ˆæœªé…ç½®æ—¶è‡ªåŠ¨ä» uplinks ä¸­è·å–ç¬¬ä¸€ä¸ª uplink çš„ URLï¼‰ |
| `concurrency` | number | 5 | å¹¶å‘ä¸‹è½½æ•° |
| `timeout` | number | 60000 | è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| `platforms` | array | - | ç›®æ ‡å¹³å°åˆ—è¡¨ |
| `sync.updateToLatest` | boolean | true | æ˜¯å¦æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ |
| `sync.includeDev` | boolean | false | æ˜¯å¦åŒ…å« devDependencies |
| `sync.includePeer` | boolean | true | æ˜¯å¦åŒ…å« peerDependencies |
| `sync.includeOptional` | boolean | true | æ˜¯å¦åŒ…å« optionalDependencies |
| `sync.maxDepth` | number | 10 | ä¾èµ–æ ‘æœ€å¤§æ·±åº¦ |

### metadata-healer é…ç½®é¡¹

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enabled` | boolean | true | æ˜¯å¦å¯ç”¨æ’ä»¶ |
| `scanCacheTTL` | number | 60000 | æ‰«æç¼“å­˜ TTLï¼ˆæ¯«ç§’ï¼‰ |
| `shasumCacheSize` | number | 10000 | shasum ç¼“å­˜å¤§å° |
| `autoUpdateLatest` | boolean | true | è‡ªåŠ¨æ›´æ–° latest æ ‡ç­¾ |

## é¡¹ç›®ç»“æ„

```
verdaccio-offline-sync/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ verdaccio-ingest-middleware/     # å¤–ç½‘ä¾§æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts                 # å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ ingest-middleware.ts     # ä¸­é—´ä»¶ä¸»ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ dependency-resolver.ts   # ä¾èµ–æ ‘è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ package-downloader.ts    # åŒ…ä¸‹è½½å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ storage-scanner.ts       # å­˜å‚¨æ‰«æå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ differential-scanner.ts  # å·®åˆ†æ–‡ä»¶æ‰«æå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ differential-packer.ts   # å·®åˆ†æ‰“åŒ…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ web-ui.ts                # Web UI æ¨¡æ¿
â”‚   â”‚   â”‚   â””â”€â”€ types.ts                 # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ verdaccio-metadata-healer/       # å†…ç½‘ä¾§æ’ä»¶
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ index.ts                 # å…¥å£
â”‚       â”‚   â”œâ”€â”€ healer-filter.ts         # è¿‡æ»¤å™¨ä¸»ç±»
â”‚       â”‚   â”œâ”€â”€ import-middleware.ts     # å¯¼å…¥ä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ import-handler.ts        # å¯¼å…¥å¤„ç†å™¨
â”‚       â”‚   â”œâ”€â”€ import-ui.ts             # å¯¼å…¥ Web UI
â”‚       â”‚   â”œâ”€â”€ storage-scanner.ts       # å­˜å‚¨æ‰«æå™¨
â”‚       â”‚   â”œâ”€â”€ metadata-patcher.ts      # å…ƒæ•°æ®ä¿®è¡¥å™¨
â”‚       â”‚   â”œâ”€â”€ shasum-cache.ts          # shasum ç¼“å­˜
â”‚       â”‚   â””â”€â”€ types.ts                 # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ package.json                         # monorepo é…ç½®
â”œâ”€â”€ pnpm-workspace.yaml
â””â”€â”€ README.md
```

## å¼€å‘

```bash
# å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºæ‰€æœ‰åŒ…
pnpm build

# æ„å»ºå•ä¸ªåŒ…
pnpm --filter verdaccio-ingest-middleware build

# æµ‹è¯•
pnpm test

# å¼€å‘æ¨¡å¼ï¼ˆç›‘å¬å˜åŒ–ï¼‰
pnpm dev
```

## å¸¸è§é—®é¢˜

### Q: å†…ç½‘å®‰è£…æ—¶æç¤ºæ‰¾ä¸åˆ°åŒ…ï¼Ÿ

1. ç¡®è®¤åŒ…å·²åŒæ­¥åˆ°å†…ç½‘ storage ç›®å½•
2. è¿è¡Œ `é‡å»ºæœ¬åœ°ç´¢å¼•` ä¿®å¤å…ƒæ•°æ®
3. æ£€æŸ¥ `offline-storage` æ’ä»¶æ˜¯å¦æ­£ç¡®é…ç½®

### Q: å¹³å°äºŒè¿›åˆ¶åŒ…ä¸‹è½½ä¸å®Œæ•´ï¼Ÿ

1. åœ¨ Web UI ä¸­å‹¾é€‰æ‰€æœ‰éœ€è¦çš„ç›®æ ‡å¹³å°
2. ç¡®ä¿ `includeOptional` é€‰é¡¹å·²å¯ç”¨
3. æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦å¯è®¿é—®

### Q: åˆ†æè¿›åº¦å¡ä½ï¼Ÿ

1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. å°è¯•å‡å°‘å¹¶å‘æ•°ï¼ˆ`concurrency` é…ç½®ï¼‰

### Q: å¦‚ä½•åªåŒæ­¥ç‰¹å®šåŒ…ï¼Ÿ

ä½¿ç”¨ API ç›´æ¥æŒ‡å®šåŒ…åˆ—è¡¨ï¼š

```bash
curl -X POST http://external:4873/_/ingest/download \
  -H "Content-Type: application/json" \
  -d '{
    "packages": [
      {"name": "react", "version": "18.2.0", "reason": "missing-dependency"},
      {"name": "lodash", "version": "4.17.21", "reason": "missing-dependency"}
    ]
  }'
```

## License

MIT
